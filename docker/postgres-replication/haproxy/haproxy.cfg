global
    maxconn 1000
    log stdout local0
    
defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    option tcp-check
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout check 5s
    
# 통계 페이지
stats enable
stats uri /stats
stats refresh 30s
stats show-node
stats auth admin:admin

# PostgreSQL 읽기 복제본 로드 밸런싱
frontend postgres_read
    bind *:5432
    mode tcp
    default_backend postgres_replicas

# 읽기 복제본 백엔드 풀
backend postgres_replicas
    mode tcp
    balance roundrobin
    option tcp-check
    
    # PostgreSQL 헬스체크
    tcp-check connect
    tcp-check send-binary 00000016 # 패킷 길이
    tcp-check send-binary 00030000 # 프로토콜 버전
    tcp-check send-binary 7573657200 # "user\0"
    tcp-check send-binary 706f7374677265730000 # "postgres\0\0"
    tcp-check expect binary 52 # 'R' - 인증 요청
    
    # 읽기 복제본 서버들 (가중치 설정)
    server replica1 postgres-replica1:5432 check weight 100 maxconn 100
    server replica2 postgres-replica2:5432 check weight 100 maxconn 100
    
    # 백업용 마스터 (읽기 전용 쿼리만)
    server master postgres-master:5432 backup check weight 50 maxconn 50